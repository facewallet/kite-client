<template>
  <ClientOnly>
    <section class="sign-lay layout-content">
      <div class="sign-view client-card">
        <div class="title">
          注册
        </div>
        <div class="js-sign-in-container">
          <form id="sign-up"
                accept-charset="UTF-8"
                method="post"
                ref="register">

            <div class="input-prepend restyle js-normal">
              <input v-model="formData.name"
                     type="text"
                     class="nickname"
                     placeholder="你的昵称">
              <i class="el-icon-user-solid"></i>
            </div>

<!--            <div class="input-prepend email-view">-->
<!--              <input v-model="formData.email"-->
<!--                     type="text"-->
<!--                     class="send-email-input account"-->
<!--                     placeholder="邮箱">-->
<!--              <i class="el-icon-message"></i>-->
<!--              <send-code :isSend="isSendCodeSuccess"-->
<!--                         v-model="isSendCode"-->
<!--                         @click.native="sendCode"-->
<!--                         storage-key="sendEmailCode"-->
<!--                         class="btn-send-email-code" />-->
<!--            </div>-->

<!--            <div class="input-prepend email-view-code"-->
<!--                 v-show="formData.email">-->
<!--              <input v-model="formData.code"-->
<!--                     type="text"-->
<!--                     class="send-email-code code"-->
<!--                     placeholder="请输入验证码">-->
<!--              <i class="el-icon-chat-round"></i>-->
<!--            </div>-->

            <div class="input-prepend">
              <input v-model="formData.password"
                     type="password"
                     class="password"
                     placeholder="密码">
              <i class="el-icon-key"></i>
            </div>

<!--            <div class="input-prepend">-->
<!--              <input v-model="formData.double_password"-->
<!--                     type="password"-->
<!--                     class="double_password"-->
<!--                     placeholder="重复密码">-->
<!--              <i class="el-icon-key"></i>-->
<!--            </div>-->

            <div class="footer-text">已有账户， <em @click="tapSign">登录</em></div>

            <button class="sign-up-button"
                    type="button"
                    @click="register">注册</button>
          </form>

        </div>
      </div>
    </section>
  </ClientOnly>
</template>

<script>
import { sendCode } from '@components'
import ClientOnly from 'vue-client-only'
import { mapState } from 'vuex'
import signModule from '../../store/module/sign'
import { cookie } from '../../utils/cookie'
export default {
  name: 'SignUp',
  metaInfo () {
    return {
      title: `${this.website.meta.website_name}-注册`,
      htmlAttrs: {
        lang: 'zh'
      }
    }
  },
  asyncData ({ store, route, accessToken = '' }) {
    // 触发 action 后，会返回 Promise
    return Promise.all([
      store.dispatch('PERSONAL_INFO', { accessToken }),
      store.dispatch('website/GET_WEBSITE_INFO'),
      store.dispatch('articleTag/GET_ARTICLE_TAG_ALL')
    ])
  },
  data () {
    return {
      isSendCode: false,
      isSendCodeSuccess: false, // 验证码是否发送
      formData: {
        name: '',
        // nickname: '',
        // email: '',
        // phone: '',
        // code: '',
        // type: 'email',
        password: '',
        // double_password: ''
      }
    }
  },
  mounted () {
    this.$store.registerModule('sign', signModule)
  },
  methods: {
    sendCode () { // 发送注册验证码
      this.isSendCodeSuccess = true
      this.$store.dispatch('sign/SIGN_SEND_CODE', { email: this.formData.email })
        .then(res => {
          this.isSendCodeSuccess = false
          if (res.state === 'success') {
            this.isSendCode = true
          } else {
            this.$message.warning(res.message)
          }
        })
    },
    register () {
      this.$store.dispatch('sign/REGISTER', this.formData)
        .then(res => {
          console.log('注册返回：', res)
          // if (res.meta.success === true) {
          if (res.meta.success === true) {
            this.$message.success(res.meta.message)
            this.$refs.register.reset()
            cookie.set('accessToken', res.data.user.token, 7)
            this.$router.push({
              name: 'home' ,
              params:{
                accessToken2:res.data.user.token
              }
            })
          } else {
            this.$message.warning(res.meta.message)
          }
          // if (res.state === 'success') {
          //   this.$message.success(res.message)
          //   this.$refs.register.reset();
          //   this.$router.push({ name: 'signIn' })
          // } else {
          //   this.$message.warning(res.message)
          // }
        })
    },
    tapSign () {
      this.$router.push({ name: 'signIn' })
    }
  },
  computed: {
    ...mapState(['website'])
  },
  components: {
    'send-code': sendCode,
    ClientOnly
  },
  destroyed () {
    this.$store.unregisterModule('sign')
  }
}
</script>

