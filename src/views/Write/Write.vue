<template>
  <client-only>
    <section class="write-lay layout-content">
      <div class="container client-card">
        <!-- this component will only be rendered on client-side -->

        <div class="write-top  box-form-group">
          <input class="box-input title"
                 v-model="write.title"
                 type="text"
                 placeholder="请输入文章标题" />
        </div>

        <div class="write mrg-bm20">
          <mavon-editor defaultOpen="edit"
                        :boxShadow="false"
                        v-model="write.content"
                        :toolbars="toolbars"
                        ref="mavonEditor"
                        :imageFilter="imageFilter"
                        @imgAdd="$imgAdd" />
        </div>

        <div class="row mrg-bm20">
          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">
            <label class="box-label"
                   for="">来源</label>
            <select class="box-select"
                    v-model="write.source">
              <option :value="item.id"
                      v-for="(item, key) in sourceList"
                      :key="key">{{ item.text }}</option>
            </select>
          </div>
          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">
            <label class="box-label"
                   for="">是否公开</label>
            <select class="box-select"
                    v-model="write.isPublic">
              <option :value="key"
                      v-for="(item, key) in publicTypeList"
                      :key="key">{{ item }}</option>
            </select>
          </div>
        </div>

        <div class="row mrg-bm20">
          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">
            <label class="box-label"
                   for="">个人专栏（非必选）</label>
            <select class="box-select"
                    v-model="write.blogIds">
              <option :value="item.blogId"
                      v-for="(item, key) in userArticleBlogAll"
                      :key="key">{{ item.name }}</option>
            </select>
            <div class="create-blog">
              <div class="create-blog-view"
                   v-show="isCreateBlogShow">
                <input class="create-blog-input box-input"
                       placeholder="请输入专栏名字"
                       v-model="blog.name"
                       type="text" />
                <button class="btn btn-primary btn-sm"
                        @click="saveCreateBlog">
                  保存
                </button>
                <button class="btn btn-primary btn-sm"
                        @click="isCreateBlogShow = false">
                  取消
                </button>
              </div>
              <button class="btn btn-primary btn-sm"
                      v-show="!isCreateBlogShow"
                      @click="isCreateBlogShow = true">
                创建新个人专栏
              </button>
            </div>
          </div>
          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">
            <label class="box-label"
                   for="">文章类型</label>
            <select class="box-select"
                    v-model="write.type">
              <option :value="key"
                      v-for="(item, key) in articleTypeText"
                      :key="key">{{ item }}</option>
            </select>
          </div>
        </div>

        <div class="tag-warp mrg-bm20">
          <p class="common-title">
            文章标签
            <span>
              <em id="chosen_tag_num">{{ currentArticleTagArr.length }}</em>/3
            </span>
          </p>
          <div class="search-box clearfix"
               ref="search_box">
            <div class="clearfix js-chosen-tags"
                 ref="js_chosen_tags"
                 v-show="currentArticleTagArr.length > 0">
              <span class="tag-item"
                    v-for="(item, key) in currentArticleTagArr"
                    :key="key"
                    @click="deleteCurrentArticleTag(item)">{{ item.name }}</span>
            </div>
            <input class="search-input"
                   v-show="currentArticleTagArr.length < 3"
                   placeholder="选择下列热门标签或输入关键词检索标签"
                   :style="{ width: searchBoxWidth }"
                   v-model="searchArticleTag" />
          </div>
          <p class="search-result js-search-result"
             v-show="isSearchResultShow">
            相关“
            <span class="js-search-text">{{ searchArticleTag }}</span>”的搜索
            <span class="js-search-num">{{
              searchShowArticleTagAll.length
            }}</span>
            个
          </p>
          <div class="tag-list-view js-tag-nano has-scrollbar">
            <div class="clearfix js-tag-list">
              <span class="tag-item"
                    v-for="(item, key) in searchShowArticleTagAll"
                    :key="key"
                    @click="addArticleTag(item)">{{ item.name }}</span>
            </div>
          </div>
        </div>

<!--        <div class="row mrg-bm20">-->
<!--          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">-->
<!--            <label class="box-label"-->
<!--                   for="">是否添加附件</label>-->
<!--            <select class="box-select"-->
<!--                    v-model="write.isAttachment">-->
<!--              <option :value="item"-->
<!--                      v-for="item in isOpen"-->
<!--                      :key="item">{{-->
<!--                isOpenInfo[item]-->
<!--              }}</option>-->
<!--            </select>-->
<!--          </div>-->
<!--          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group"-->
<!--               v-if="Number(write.isAttachment) === isOpen.yes">-->
<!--            <label class="box-label"-->
<!--                   for="">开启付费</label>-->
<!--            <select class="box-select"-->
<!--                    v-model="write.isFree">-->
<!--              <option :value="item"-->
<!--                      v-for="item in isFree"-->
<!--                      :key="item">{{-->
<!--                isFreeText[item]-->
<!--              }}</option>-->
<!--            </select>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="row mrg-bm20"-->
<!--             v-if="-->
<!--            Number(write.isFree || 1) !== isFree.free &&-->
<!--              Number(write.isAttachment) === isOpen.yes-->
<!--          ">-->
<!--          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">-->
<!--            <label class="box-label"-->
<!--                   for="">支付类型</label>-->
<!--            <select class="box-select"-->
<!--                    v-model="write.pay_type">-->
<!--              <option :value="key"-->
<!--                      v-for="(item, key) in payTypeText"-->
<!--                      :key="key">{{ item }}</option>-->
<!--            </select>-->
<!--          </div>-->
<!--          <div class="col-xs-12 col-sm-6 col-md-6 box-form-group">-->
<!--            <label class="box-label"-->
<!--                   for="">价格 ￥({{ payTypeText[write.pay_type] }})</label>-->
<!--            <input type="text"-->
<!--                   class="box-input"-->
<!--                   @keyup="isFloor"-->
<!--                   v-model="write.price" />-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="row mrg-bm20"-->
<!--             v-if="Number(write.isAttachment) === isOpen.yes">-->
<!--          <div class="col-xs-12 col-sm-12 col-md-12">-->
<!--            <label class="box-label"-->
<!--                   for="">附件内容(支持markdown)</label>-->
<!--            <textarea class="box-textarea"-->
<!--                      cols="30"-->
<!--                      v-model="write.attachment"-->
<!--                      rows="10"></textarea>-->
<!--          </div>-->
<!--        </div>-->

        <div class="write-footer clearfix">
          <button class="send-article"
                  @click="saveArticle">发布文章</button>
        </div>
      </div>
    </section>
  </client-only>
</template>

<script>
// Local Registration
import { mavonEditor } from '@components/MarkDown'
import ClientOnly from 'vue-client-only'
import marked from 'marked'
import { share, baidu, google } from '@utils'
import {
  statusList,
  articleType,
  statusListText,
  articleTypeText,
  payTypeText,
  isFree,
  isFreeText,
  isOpen,
  isOpenInfo
} from '@utils/constant'
import editorModule from '../../store/module/editor'
export default {
  name: 'write',
  metaInfo () {
    return {
      title: '文章编辑',
      htmlAttrs: {
        lang: 'zh'
      }
    }
  },
  async asyncData ({ store, route, accessToken = '' }) {
    // 触发 action 后，会返回 Promise
    return Promise.all([
      store.dispatch('PERSONAL_INFO', { accessToken }),
      // store.dispatch('articleTag/GET_ARTICLE_TAG_ALL'),
      store.dispatch("articleColumn/GET_ARTICLE_COLUMN_ALL")

    ])
  },
  data () {
    return {
      write: {
        title: '', // 文章的标题
        source: '1', // 文章的来源
        content: '', // 文章的内容
        blogIds: '', // 文章所属专栏ID
        type: '1', // 文章的类型
        isPublic: 1, // 是否公开 1公开 0仅自己可见
        isAttachment: 2, // 是否添加附件
        isFree: 1, // 免费还是付费
        pay_type: 1, // 支付类型
        price: 0, // 价格
        attachment: ''
      },
      publicTypeList: ['仅自己可见', '公开'], // 文章类型列表
      payTypeText,
      isFree,
      isFreeText,
      isOpen,
      isOpenInfo,
      articleTypeText,
      blog: {
        name: ''
      },
      userArticleBlogAll: [], // 用户全部专栏
      sourceList: [
        // 文章来源
        // whether to display create blog btn and input 文章类型列表
        {
          id: '1',
          text: '原创'
        },
        {
          id: '2',
          text: '转载'
        }
      ],
      isCreateBlogShow: false, // 是否显示创建blog
      searchArticleTag: '',
      currentArticleTagArr: [], // 用户选中的文章标签
      isSearchResultShow: false, // 搜索结果显示
      searchShowArticleTagAll: [], // 搜索栏内呈现的文章标题
      searchBoxWidth: '100%',
      toolbars: {
        bold: true, // 粗体
        italic: true, // 斜体
        header: true, // 标题
        underline: true, // 下划线
        mark: true, // 标记
        superscript: true, // 上角标
        quote: true, // 引用
        ol: true, // 有序列表
        link: true, // 链接
        imagelink: true, // 图片链接
        help: true, // 帮助
        code: true, // code
        subfield: true, // 是否需要分栏
        fullscreen: true, // 全屏编辑
        /* 1.3.5 */
        undo: true, // 上一步
        trash: true, // 清空
        save: false // 保存（触发events中的save事件）
        /* 1.4.2 */
      }
    }
  },
  mounted () {
    this.$store.registerModule('editor', editorModule)
    this.initArticleTagAll()
    this.getUserArticleBlogAll()
    if (this.$route.params.type !== 'create') {
      this.isEditArticle()
    }
  },
  watch: {
    searchArticleTag (val) {
      let _arr = []
      for (let item in this.articleTagAll) {
        if (
          this.articleTagAll[item].name
            .toLowerCase()
            .indexOf(this.searchArticleTag.toLowerCase()) >= 0
        ) {
          _arr.push(this.articleTagAll[item])
        }
      }
      this.searchShowArticleTagAll = _arr
      if (this.searchArticleTag.length === 0) {
        this.isSearchResultShow = false
      } else {
        this.isSearchResultShow = true
      }
    }
  },
  methods: {
    isEditArticle () {
      if (this.$route.params.type !== 'create') {
        // 判断是不是创建，不是则是修改，同时赋值
        this.$store
          .dispatch('editor/GET_USER_ARTICLE', {
            aid: this.$route.params.type
          })
          .then(result => {
            if (result.meta.success === true) {
              const articleInfo = result.data.article
              // const articleAnnexInfo = result.data.articleAnnex
              // this.write = { ...articleInfo, ...articleAnnexInfo }
              this.write = { ...articleInfo }
              this.write.isPublic = Number(articleInfo.isPublic)
              this.write.content = articleInfo.originContent
              this.write.title = articleInfo.title
              this.articleTagAll.map(item => {
                if (
                  ~articleInfo.tagIds.split(',').indexOf(String(item.columnId))
                  // ~articleInfo.tagIds.split(',').indexOf(String(item.tagId))
                ) {
                  this.currentArticleTagArr.push(item)
                }
              })
              if (result.data.articleAnnex) {
                // 附件
                this.write.isAttachment = articleInfo.isAttachment
                this.write.attachment = articleAnnexInfo.origin_attachment
              }
              this.renderCurrentArticleTag()
            } else {
              this.$message.warning(result.message)
              this.$router.push({ name: 'home' })
            }
          })
      }
    },
    isFloor () {
      var obj = event.target
      var t = obj.value.charAt(0)
      obj.value = obj.value
        .replace('.', '$#$') //把第一个字符'.'替换成'$#$'
        .replace(/\./g, '') //把其余的字符'.'替换为空
        .replace('$#$', '.') //把字符'$#$'替换回原来的'.'
        .replace(/[^\d.]/g, '') //只能输入数字和'.'
        .replace(/^\./g, '') //不能以'.'开头
        .replace(/([0-9]+\.[0-9]{2})[0-9]*/, '$1') //只保留2位小数
      if (t == '-') {
        obj.value = '-' + obj.value
      }
    },
    initArticleTagAll () {
      this.searchShowArticleTagAll = this.articleTagAll
    },
    getUserArticleBlogAll () {
      if (!this.$store.state.personalInfo.islogin) {
        this.$message.warning('当前用户未登陆，请前往首页登陆后尝试')
        this.$router.push({ name: 'home' })
        return false
      }
      this.$store
        .dispatch('editor/GET_USER_BLOG', {
          uid: this.$store.state.personalInfo.user.uid
        })
        .then(res => {
          this.userArticleBlogAll = res.data.list
        })
    },
    addArticleTag (val) {
      this.search_article_tag = ''
      let _arr = []
      for (var item in this.currentArticleTagArr) {
        _arr.push(this.currentArticleTagArr[item].name)
      }
      if (
        this.currentArticleTagArr.length < 3 &&
        _arr.indexOf(val.name) === -1
      ) {
        this.currentArticleTagArr.push(val)
      }
      this.renderCurrentArticleTag()
    },
    deleteCurrentArticleTag (val) {
      for (var item in this.currentArticleTagArr) {
        if (val.name === this.currentArticleTagArr[item].name) {
          this.currentArticleTagArr.splice(item, 1)
        }
      }
      this.renderCurrentArticleTag()
    },
    renderCurrentArticleTag () {
      this.$nextTick(() => {
        this.searchBoxWidth =
          this.$refs.search_box.offsetWidth -
          this.$refs.js_chosen_tags.offsetWidth -
          15 +
          'px'
      })
    },
    getObjectValues (object) {
      var values = []
      for (var property in object) {
        values.push(object[property].columnId)
        // values.push(object[property].tagId)
      }
      return values
    },
    saveCreateBlog () {
      this.$store
        .dispatch('editor/CREATE_ARTICLE_BLOG', {
          name: this.blog.name
        })
        .then(res => {
          if (res.meta.success === true){
            this.$message.success('创建文章专题成功')
            this.blog.name = ''
            this.getUserArticleBlogAll()
            this.isCreateBlogShow = false
          } else {
            this.$message.warning(res.message)
          }
        })
    },
    imageFilter (file) {
      if (file.size > 1 * 1024 * 1024) {
        this.$message.success('上传文章图片应该小于1M')
        return false
      } else {
        return true
      }
    },
    $imgAdd (pos, $file) {
      // 第一步.将图片上传到服务器.
      var formData = new FormData()
      formData.append('fileType', 'admin')
      formData.append('file', $file)
      this.$store
        .dispatch('common/UPLOAD_FILE', formData)
        .then(res => {
          if (res.state === 'success') {
            this.$message.success('上传文章图片成功')
            this.$refs.mavonEditor.$img2Url(pos, res.data.fileUrl)
          } else {
            this.$message.warning(res.message)
            return false
          }
        })
    },
    saveArticle () {
      const { isAttachment, isFree, pay_type, price, attachment } = this.write
      let params = {
        title: this.write.title, //文章的标题
        content: marked(this.write.content, { breaks: true }) /*主内容*/,
        originContent: this.write.content /*源内容*/,
        source: this.write.source, // 来源 （1原创 2转载）
        type: this.write.type, // 类型 （1:文章;2:日记,3:草稿 ）
        isPublic: this.write.isPublic,
        blogIds: this.write.blogIds,
        tagIds: this.getObjectValues(this.currentArticleTagArr).join(','),
        // 2020.3.6加
        isAttachment: isAttachment,
        // isFree,
        // pay_type,
        // price: Number(price),
        // attachment: attachment
        //   ? marked(attachment, { breaks: true })
        //   : '' /*主内容*/,
        // origin_attachment: attachment /*源内容*/
      }
      this.$route.params.type !== 'create' &&
        (params.aid = this.$route.params.type)
      params.uid = this.personalInfo.user.uid;
      let dispatch_url =
        this.$route.params.type === 'create'
          ? 'editor/SAVE_ARTICLE'
          : 'editor/UPDATE_ARTICLE'

      this.$store
        .dispatch(dispatch_url, params)
        .then(res => {
          if (res.meta.success === true) {
            console.log('11111', this.personalInfo.user.uid)
            this.$message.success(res.meta.message)
            this.$router.push({
              name: 'user',
              params: { uid: this.personalInfo.user.uid, routeType: 'article' }
            })
          } else {
            this.$message.warning(res.meta.message)
          }
        })
        .catch(function (err) {
          this.$message.error('出现错误：' + err)
        })
    }
  },
  components: {
    'mavon-editor': mavonEditor,
    ClientOnly
  },
  computed: {
    articleTagAll () {
      return this.$store.state.articleColumn.homeColumn
      // return this.$store.state.articleTag.article_tag_all
    },
    personalInfo () {
      // 登录后的个人信息
      return this.$store.state.personalInfo
    }
  },
  destroyed () {
    this.$store.unregisterModule('editor')
  }
}
</script>

<style lang="scss" scoped>
.write-lay {
  .client-card {
    padding: 15px 20px 30px;
    margin-bottom: 30px;
  }
  .write-top {
    margin: 15px 0;
    .title {
      width: 100%;
      padding: 10px 15px;
    }
  }
  .write {
    /deep/.v-note-wrapper {
      min-height: 700px;
      z-index: 249;
      &.fullscreen {
        z-index: 251;
      }
    }
  }

  .box-input,
  .box-select {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
  }
  .box-select {
    height: 36px;
  }

  .box-label {
    display: block;
  }
  .box-input {
    font-size: 14px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    width: 100%;
    height: 36px;
    padding: 0 20px;
  }
  .box-textarea {
    margin-top: 10px;
    border: 1px solid #e0e0e0;
    height: 100px;
  }

  .blog-warp {
    margin-bottom: 15px;
    .common-title {
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 14px;
      color: #1c1f21;
      line-height: 22px;
    }
    .common-select-box {
      position: relative;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      color: #1c1f21;
      cursor: pointer;
      font-size: 14px;
      width: 200px;
      i {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 20px;
        color: #9199a1;
        line-height: 20px;
      }
      .common-select-name {
        display: block;
        padding: 0 40px 0 12px;
        height: 32px;
        line-height: 32px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        box-sizing: border-box;
      }
      .common-select-ul {
        position: absolute;
        max-height: 250px;
        z-index: 1;
        top: 33px;
        padding: 8px 0;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
        box-shadow: 0 8px 16px 0 rgba(28, 31, 33, 0.2);
        border-radius: 8px;
        overflow-y: auto;
        li {
          padding: 0 16px;
          height: 33px;
          line-height: 33px;
          box-sizing: border-box;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          &.active,
          &:hover {
            background: #f3f5f6;
          }
        }
      }
    }
    &.blog-warp-blog {
      float: left;
    }
  }

  .tag-warp {
    margin-top: 5px;
    .common-title {
      span {
        margin-left: 4px;
        font-weight: 400;
        font-size: 12px;
        color: #93999f;
        line-height: 22px;
      }
    }
    .search-box {
      width: 100%;
      height: 36px;
      padding-left: 12px;
      margin-right: 12px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      box-sizing: border-box;
      .search-input {
        width: 100%;
        height: 100%;
        float: left;
        font-size: 14px;
        border-radius: 6px;
        border: 0;
      }
    }
    .js-chosen-tags {
      float: left;
      height: 100%;
      .tag-item {
        margin-top: 5px;
      }
    }
    .tag-item {
      display: block;
      float: left;
      margin: 8px 8px 0 0;
      padding: 4px 12px;
      font-size: 12px;
      color: #545c63;
      line-height: 16px;
      background: rgba(84, 92, 99, 0.1);
      border-radius: 12px;
      cursor: pointer;
    }
    .search-result {
      margin: 24px 0 -16px;
      font-size: 12px;
      color: #9199a1;
      line-height: 18px;
      .js-search-text {
        color: #00bb29;
      }
      .js-search-num {
        color: #00bb29;
      }
    }
    .common-error-tip {
      margin-top: 2px;
      font-size: 12px;
      color: #f53d3d;
      line-height: 18px;
    }
    .tag-list-view {
      width: 100%;
      margin-top: 16px;
      height: auto !important;
      max-height: 300px;
      overflow-y: auto;
    }
  }

  .create-blog {
    margin-top: 10px;
    .create-blog-input {
      height: 36px;
      padding: 0 12px;
      font-size: 14px;
    }
  }

  .write-footer {
    margin: 20px 0;
    .send-article {
      padding: 12px 60px;
      background: #fd763a;
      border: none;
      color: #fff;
      display: block;
      margin: 0 auto;
      font-size: 15px;
      border-radius: 5px;
    }
  }
}
</style>
